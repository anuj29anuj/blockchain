<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockchain Demo</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1> SHOWING <span class="accent">Validation</span></h1>
        <p>Modify any block to see the chain reaction of hash updates.</p>
      </header>

      <div id="blockchain" class="blockchain-grid">
        {% for block in blockchain %}
        <div class="block-card" id="block-{{ loop.index0 }}">
          <div class="block-header">
            <span class="block-label">BLOCK #{{ block.block_no }}</span>
          </div>
          <div class="field-group">
            <label>Nonce</label>
            <input
              type="number"
              class="nonce-input"
              value="{{ block.nonce }}"
              
            />
          </div>
          <div class="field-group">
            <label>Data</label>
            <textarea
              class="data-input"
              
            >
{{ block.data }}</textarea
            >
          </div>
          <div class="field-group">
            <label>Previous Hash</label>
            <div class="hash-display prev-hash">{{ block.prev_hash }}</div>
          </div>
          <div class="field-group">
            <label>Hash</label>
            <div class="hash-display current-hash">{{ block.hash }}</div>
          </div>
    
<div class="button-group">
  <button class="update-btn" onclick="updateSingleBlock({{ loop.index0 }})">Update</button>
  <button class="mine-btn" onclick="mineBlock({{ loop.index0 }})">Mine</button>
  <button class="propagate-btn" onclick="propagateFromBlock({{ loop.index0 }})">Propagate</button>
</div>


        </div>
        {% endfor %}
      </div>
    </div>


    <script>
  async function updateSingleBlock(index) {
    const card = document.getElementById(`block-${index}`);
    const data = card.querySelector(".data-input").value;
    const nonce = card.querySelector(".nonce-input").value;

    const response = await fetch("/update_block", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ index, data, nonce }),
    });

    const blockchain = await response.json();
    renderBlockchain(blockchain);
  }

  async function propagateFromBlock(index) {
    const response = await fetch("/propagate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ index }),
    });

    const blockchain = await response.json();
    renderBlockchain(blockchain);
  }

  async function mineBlock(index) {
    const response = await fetch("/mine_block", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index }),
    });
    const blockchain = await response.json();
    renderBlockchain(blockchain);
}

async function checkValidation() {
    const response = await fetch("/validate");
    const results = await response.json();
    
    results.forEach(res => {
        const card = document.getElementById(`block-${res.index}`);
        if (res.valid) {
            card.style.borderColor = "#2ecc71"; // Green if valid
            card.style.backgroundColor = "rgba(46, 204, 113, 0.05)";
        } else {
            card.style.borderColor = "#e74c3c"; // Red if invalid
            card.style.backgroundColor = "rgba(231, 76, 60, 0.05)";
        }
    });
}

// Call checkValidation inside your renderBlockchain function
function renderBlockchain(blockchain) {
    blockchain.forEach((block, index) => {
        const card = document.getElementById(`block-${index}`);
        card.querySelector(".nonce-input").value = block.nonce;
        card.querySelector(".data-input").value = block.data;
        card.querySelector(".prev-hash").textContent = block.prev_hash;
        card.querySelector(".current-hash").textContent = block.hash;
    });
    checkValidation(); // Refresh colors
}

// Run validation once on load
window.onload = checkValidation;

 
</script>





   
  </body>
</html>
